# Complete System Architecture - Authentication + Lobby

## ??? **System Overview**

```
???????????????????????????????????????????????????????????????????
?                    AUTHENTICATION LAYER                          ?
?                     (Firebase + PlayerPrefs)                     ?
???????????????????????????????????????????????????????????????????
                            ?
???????????????????????????????????????????????????????????????????
?                      LOBBY LAYER                                 ?
?                   (Netcode + LAN Discovery)                      ?
???????????????????????????????????????????????????????????????????
                            ?
???????????????????????????????????????????????????????????????????
?                      GAME LAYER                                  ?
?              (Multiplayer Disaster Simulation)                   ?
???????????????????????????????????????????????????????????????????
```

---

## ?? **Complete Flow Diagram**

```
START: Application Launch
         ?
         ?
???????????????????????
?   CHOOSE USER TYPE  ? ? User selects: Instructor / Trainee / Super Admin
???????????????????????
         ?
         ?
???????????????????????
?   LOGIN SCREEN      ?
?  (AuthManager.cs)   ?
?                     ?
?  Inputs:            ?
?  - Username         ?
?  - Password         ?
???????????????????????
         ?
         ????????????????????????????????
         ?                              ?
    Instructor                      Trainee
         ?                              ?
         ?                              ?
???????????????????????      ???????????????????????
? Login as Instructor ?      ?  Login as Trainee   ?
?                     ?      ?                     ?
? Firebase Auth       ?      ?  Firebase Auth      ?
? ?? Verify email     ?      ?  ?? Verify email    ?
? ?? Check password   ?      ?  ?? Check password  ?
?                     ?      ?                     ?
? On Success:         ?      ?  On Success:        ?
? PlayerPrefs.Set     ?      ?  PlayerPrefs.Set    ?
? ("Type_Of_User",    ?      ?  ("Type_Of_User",   ?
?  "instructor")      ?      ?   "trainee")        ?
?                     ?      ?                     ?
? PlayerPrefs.Set     ?      ?  PlayerPrefs.Set    ?
? ("Name", name)      ?      ?  ("Name", name)     ?
???????????????????????      ???????????????????????
         ?                              ?
         ????????????????????????????????
                        ?
                        ?
         ????????????????????????????
         ?    MAIN MENU PANEL       ?
         ?   (After Login)          ?
         ?                          ?
         ?  ??????????????????????  ?
         ?  ?  "Play Game" BTN   ?  ? ? Both roles see this
         ?  ??????????????????????  ?
         ?          ?               ?
         ?          ?               ?
         ?   MainMenu.GoToLobby()  ?
         ?          ?               ?
         ????????????????????????????
                    ?
                    ?
    SceneManager.LoadScene("LobbyMenu")
                    ?
                    ?
???????????????????????????????????????????????????????????????????
?                     LOBBY MENU SCENE                             ?
?                                                                  ?
?  ????????????????????????????????????????????????????????????  ?
?  ?  LobbyMenuManager.Awake()                                 ?  ?
?  ?  ?? Spawn NetworkManager (if not exists)                  ?  ?
?  ?  ?? DontDestroyOnLoad(NetworkManager)                     ?  ?
?  ????????????????????????????????????????????????????????????  ?
?                                                                  ?
?  ????????????????????????????????????????????????????????????  ?
?  ?  LobbyMenuManager.Start()                                 ?  ?
?  ?  ?? Read: userRole = PlayerPrefs.Get("Type_Of_User")      ?  ?
?  ?  ?? SetupUIBasedOnRole()                                  ?  ?
?  ????????????????????????????????????????????????????????????  ?
?                                                                  ?
?         ?????????????????????????????????                       ?
?         ?  if (userRole == "instructor") ?                       ?
?         ?????????????????????????????????                       ?
?                     ?                                            ?
?                     ?                                            ?
?  ????????????????????????????????????????????????????????????  ?
?  ?          CREATE LOBBY PANEL (INSTRUCTOR)                  ?  ?
?  ?  ??????????????????????????????????????????????????????  ?  ?
?  ?  ?  "Create Lobby" Button                             ?  ?  ?
?  ?  ?    ?                                                ?  ?  ?
?  ?  ?    ?                                                ?  ?  ?
?  ?  ?  OnCreateLobbyClicked()                            ?  ?  ?
?  ?  ?  ?? Generate lobby code: "GAME42"                  ?  ?  ?
?  ?  ?  ?? Save to PlayerPrefs                            ?  ?  ?
?  ?  ?  ?? Display code on screen                         ?  ?  ?
?  ?  ?  ?? NetworkManager.StartHost()                     ?  ?  ?
?  ?  ?  ?? Start LobbyBroadcaster (LAN)                   ?  ?  ?
?  ?  ?  ?? Load "LobbyRoom" scene (2s delay)             ?  ?  ?
?  ?  ??????????????????????????????????????????????????????  ?  ?
?  ????????????????????????????????????????????????????????????  ?
?                                                                  ?
?                                                                  ?
?         ?????????????????????????????????                       ?
?         ?  if (userRole == "trainee")    ?                       ?
?         ?????????????????????????????????                       ?
?                     ?                                            ?
?                     ?                                            ?
?  ????????????????????????????????????????????????????????????  ?
?  ?           JOIN LOBBY PANEL (TRAINEE)                      ?  ?
?  ?  ??????????????????????????????????????????????????????  ?  ?
?  ?  ?  Input Field: "Enter Lobby Code"                    ?  ?  ?
?  ?  ?  "Join Lobby" Button                                ?  ?  ?
?  ?  ?    ?                                                 ?  ?  ?
?  ?  ?    ?                                                 ?  ?  ?
?  ?  ?  OnJoinLobbyClicked()                               ?  ?  ?
?  ?  ?  ?? Get code from input                             ?  ?  ?
?  ?  ?  ?? Start LobbyScanner (LAN)                        ?  ?  ?
?  ?  ?  ?? Search for matching code                        ?  ?  ?
?  ?  ?  ?                                                   ?  ?  ?
?  ?  ?  ?? OnLobbyFound(ip, port)                          ?  ?  ?
?  ?  ?  ?  ?? NetworkManager.StartClient()                 ?  ?  ?
?  ?  ?  ?  ?? Connect to host IP                           ?  ?  ?
?  ?  ?  ?                                                   ?  ?  ?
?  ?  ?  ?? OnScanTimeout()                                 ?  ?  ?
?  ?  ?     ?? Show "Lobby not found" error                 ?  ?  ?
?  ?  ??????????????????????????????????????????????????????  ?  ?
?  ????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
                    ?
         Host loads scene (Instructor)
         Client auto-follows (Trainee)
                    ?
                    ?
???????????????????????????????????????????????????????????????????
?                     LOBBY ROOM SCENE                             ?
?                  (LobbyRoomManager.cs)                           ?
?                                                                  ?
?  ???????????????????????????    ????????????????????????????   ?
?  ?   HOST PANEL            ?    ?   CLIENT PANEL           ?   ?
?  ?   (Instructor)          ?    ?   (Trainee)              ?   ?
?  ?                         ?    ?                          ?   ?
?  ?  Game Configuration:    ?    ?  Waiting Room:           ?   ?
?  ?  ?? Task Count: 5-8     ?    ?  ?? "Waiting for host"   ?   ?
?  ?  ?? Disaster:           ?    ?  ?? View settings        ?   ?
?  ?  ?  • Flood             ?    ?  ?  (read-only)          ?   ?
?  ?  ?  • Earthquake        ?    ?  ?? Connected players    ?   ?
?  ?  ?  • TestKen           ?    ?                          ?   ?
?  ?  ?? Duration:           ?    ????????????????????????????   ?
?  ?  ?  • 5 min                                                  ?
?  ?  ?  • 8 min             ?    NetworkVariables:              ?
?  ?  ?  • 10 min            ?    ?? taskCount (synced)          ?
?  ?  ?                      ?    ?? disasterIndex (synced)      ?
?  ?  ?? [START GAME] BTN    ?    ?? durationIndex (synced)      ?
?  ?       ?                 ?                                    ?
?  ???????????????????????????                                    ?
?          ?                                                       ?
?          ?                                                       ?
?  OnStartGameClicked()                                           ?
?  ?? Reset PointManager                                          ?
?  ?? Save settings to PlayerPrefs                                ?
?  ?  ?? TaskCount                                                ?
?  ?  ?? DisasterType                                             ?
?  ?  ?? GameDuration                                             ?
?  ?  ?? CameFromLobby = 1                                        ?
?  ?                                                               ?
?  ?? NetworkSceneManager.LoadScene(disasterScene)                ?
?     ?? Host loads scene                                         ?
?     ?? All clients auto-follow                                  ?
???????????????????????????????????????????????????????????????????
                    ?
         Both host & clients load game
                    ?
                    ?
???????????????????????????????????????????????????????????????????
?               GAME SCENE (Flood/Earthquake/TestKen)              ?
?                     (GameManager.cs)                             ?
?                                                                  ?
?  OnSceneLoaded():                                                ?
?  ?? Read PlayerPrefs:                                            ?
?  ?  ?? TaskCount ? Spawn that many victims                      ?
?  ?  ?? DisasterType ? Load correct disaster                     ?
?  ?  ?? GameDuration ? Set timer                                 ?
?  ?                                                               ?
?  ?? Start multiplayer gameplay:                                 ?
?     ?? Networked player movement                                ?
?     ?? Networked victim rescue                                  ?
?     ?? Networked point tracking                                 ?
?                                                                  ?
?  Game Loop (Networked):                                          ?
?  ?? Players rescue victims                                       ?
?  ?? Points synchronized across clients                          ?
?  ?? Timer counts down                                            ?
?                                                                  ?
?  Game End:                                                       ?
?  ?? When time == 0 OR all victims rescued                        ?
?     ?? SceneManager.LoadScene("Result")                          ?
???????????????????????????????????????????????????????????????????
                    ?
                    ?
???????????????????????????????????????????????????????????????????
?                     RESULT SCENE                                 ?
?                                                                  ?
?  Display:                                                        ?
?  ?? Final score                                                  ?
?  ?? Victims rescued / total                                      ?
?  ?? Time taken                                                   ?
?  ?? Save to Firebase                                             ?
?                                                                  ?
?  Options:                                                        ?
?  ?? "Play Again" ? Back to LobbyRoom                             ?
?  ?? "Main Menu" ? Cleanup & back to MainMenu                     ?
?                     ?? NetworkManager.Shutdown()                 ?
?                     ?? PlayerPrefs cleared                       ?
???????????????????????????????????????????????????????????????????
```

---

## ?? **Key Data Flow**

### **Authentication ? Lobby:**
```
AuthManager
    ? Sets
PlayerPrefs
    ?? "Type_Of_User" ? "instructor" or "trainee"
    ?? "Name" ? User's name
    ?? "LoginAlready" ? "true"
    ? Read by
LobbyMenuManager
    ?? Shows correct UI based on role
```

### **Lobby ? Game:**
```
LobbyRoomManager
    ? Sets
PlayerPrefs
    ?? "LobbyCode" ? Current lobby code
    ?? "TaskCount" ? Number of victims (5-8)
    ?? "DisasterType" ? "Flood" / "Earthquake" / "TestKen"
    ?? "GameDuration" ? Duration in seconds
    ?? "CameFromLobby" ? 1
    ? Read by
GameManager
    ?? Configures game based on settings
```

---

## ?? **Network Architecture**

### **No Network (MainMenu):**
```
MainMenu Scene
    ?? Firebase Authentication (cloud)
    ?? Local PlayerPrefs storage
    
NetworkManager.Singleton: null
```

### **Network Starts (LobbyMenu):**
```
LobbyMenu Scene
    ?? Spawns NetworkManager
    ?   ?? DontDestroyOnLoad ?
    ?
    ?? Instructor:
    ?   ?? StartHost() on port 7777
    ?   ?? LobbyBroadcaster on port 7778 (UDP)
    ?
    ?? Trainee:
        ?? StartClient()
        ?? LobbyScanner on port 7778 (UDP)

NetworkManager.Singleton: EXISTS
```

### **Network Persists (LobbyRoom ? Game ? Result):**
```
All subsequent scenes:
    ?? NetworkManager in DontDestroyOnLoad
        ?? Maintains connections
        ?? Syncs NetworkVariables
        ?? Handles scene loading

NetworkManager.Singleton: PERSISTS
```

---

## ?? **LAN Discovery Flow**

```
INSTRUCTOR (Host):
???????????????????????????????????
?  1. Generate code: "GAME42"     ?
?  2. Start host: 0.0.0.0:7777    ?
?  3. Start broadcaster:          ?
?     Every 1 second, send:       ?
?     "GAME42|192.168.1.100|7777" ?
?     via UDP to 255.255.255.255  ?
???????????????????????????????????

TRAINEE (Client):
???????????????????????????????????
?  1. Enter code: "GAME42"        ?
?  2. Start scanner:              ?
?     Listen on UDP port 7778     ?
?  3. Receive broadcasts:         ?
?     "GAME42|192.168.1.100|7777" ?
?  4. Match code ? Found!         ?
?  5. Connect to: 192.168.1.100   ?
???????????????????????????????????
```

---

## ?? **Component Responsibilities**

| Component | Responsibility | Persists? |
|-----------|----------------|-----------|
| **AuthManager** | Login, user management | MainMenu only |
| **MainMenu** | Scene navigation | MainMenu only |
| **NetworkManager** | Network connections | LobbyMenu ? End |
| **LobbyMenuManager** | Lobby creation/joining | LobbyMenu only |
| **LobbyBroadcaster** | LAN code broadcasting | LobbyMenu only |
| **LobbyScanner** | LAN code scanning | LobbyMenu only |
| **LobbyRoomManager** | Game configuration | LobbyRoom only |
| **GameManager** | Game logic | Game scenes |
| **PointManager** | Score tracking | All scenes |

---

This diagram shows the complete integration of your authentication system with the new lobby system! ??
