# NetworkManager Initialization Flow

## ?? Complete Flow Diagram

```
???????????????????????????????????????????????????????????????????
?                    MAIN MENU SCENE                               ?
?  ??????????????????????????????????????????????????????????    ?
?  ?  ?? User Authentication                                  ?    ?
?  ?  ?? Login as Instructor or Trainee                      ?    ?
?  ?  ?? Store role in PlayerPrefs                           ?    ?
?  ?  ?? Click "Play Game" button                            ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                                                                   ?
?  ? NO NetworkManager                                            ?
?  ? NO NetworkManagerInitializer                                 ?
?  ? NO Network Components at all                                 ?
???????????????????????????????????????????????????????????????????
                            ?
                            ? SceneManager.LoadScene("LobbyMenu")
                            ?
???????????????????????????????????????????????????????????????????
?                    LOBBY MENU SCENE                              ?
?  ??????????????????????????????????????????????????????????    ?
?  ?  LobbyMenuManager.Awake()                               ?    ?
?  ?  ?? InitializeNetworkManager()                          ?    ?
?  ?  ?  ?? Check if NetworkManager.Singleton exists         ?    ?
?  ?  ?  ?? Instantiate NetworkManager from prefab          ?    ?
?  ?  ?  ?? DontDestroyOnLoad(networkManager)               ?    ?
?  ?  ?  ?? ? NetworkManager now persists!                  ?    ?
?  ?  ?? UnityMainThreadDispatcher.Instance()                ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                                                                   ?
?  Components in scene:                                            ?
?  ?? LobbyMenuManager (spawns NetworkManager)                    ?
?  ?? UnityMainThreadDispatcher                                   ?
?  ?? Create Lobby Panel (Instructor UI)                          ?
?  ?? Join Lobby Panel (Trainee UI)                               ?
?                                                                   ?
?  During Awake(), spawns to DontDestroyOnLoad:                   ?
?  ?? NetworkManager (Persistent) ? Lives here from now on!       ?
?  ?? UnityMainThreadDispatcher ? Lives here from now on!         ?
???????????????????????????????????????????????????????????????????
                            ?
         ??????????????????????????????????????
         ?                                     ?
    Instructor                             Trainee
    (Create)                               (Join)
         ?                                     ?
         ?                                     ?
???????????????????                  ???????????????????
? Generate Code   ?                  ? Enter Code      ?
? "GAME42"        ?                  ? "GAME42"        ?
???????????????????                  ???????????????????
         ?                                     ?
         ? StartHost()                         ? StartClient()
         ? (0.0.0.0:7777)                     ? Scan LAN
         ?                                     ?
         ? Start Broadcasting                  ? Find Host IP
         ? "GAME42|192.168.1.100|7777"        ?
         ?                                     ?
         ?                                     ? Connect to
         ?                                     ? 192.168.1.100:7777
         ?                                     ?
         ???????????????????????????????????????
                        ?
         NetworkSceneManager.LoadScene("LobbyRoom")
                        ?
                        ?
???????????????????????????????????????????????????????????????????
?                    LOBBY ROOM SCENE                              ?
?  ??????????????????????????????????????????????????????????    ?
?  ?  LobbyRoomManager (NetworkBehaviour)                    ?    ?
?  ?  ?? Has NetworkObject component ?? REQUIRED!            ?    ?
?  ?  ?? NetworkVariables (synced settings):                ?    ?
?  ?  ?  ?? taskCount                                        ?    ?
?  ?  ?  ?? disasterIndex                                    ?    ?
?  ?  ?  ?? durationIndex                                    ?    ?
?  ?  ?? Auto-synced to all connected clients               ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                                                                   ?
?  HOST View:                      CLIENT View:                    ?
?  ?? Configuration Panel          ?? Waiting Panel                ?
?  ?? Can change settings          ?? Read-only view               ?
?  ?? "START GAME" button          ?? Auto-follows host            ?
?                                                                   ?
?  NetworkManager still in DontDestroyOnLoad ?                    ?
???????????????????????????????????????????????????????????????????
                            ?
                   Host clicks "START GAME"
                            ?
         NetworkSceneManager.LoadScene("Flood"/"Earthquake"/"TestKen")
                            ?
                            ?
???????????????????????????????????????????????????????????????????
?                    GAME SCENE                                    ?
?  ??????????????????????????????????????????????????????????    ?
?  ?  GameManager                                            ?    ?
?  ?  ?? Reads settings from PlayerPrefs                     ?    ?
?  ?  ?? Spawns victims (TaskCount)                          ?    ?
?  ?  ?? Starts timer (Duration)                             ?    ?
?  ?  ?? Networked gameplay                                  ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                                                                   ?
?  NetworkManager still in DontDestroyOnLoad ?                    ?
?  ?? Syncing game state                                          ?
?  ?? Player positions                                             ?
?  ?? Game events                                                  ?
???????????????????????????????????????????????????????????????????
                            ?
                    Game ends (time up or all saved)
                            ?
                   SceneManager.LoadScene("Result")
                            ?
                            ?
???????????????????????????????????????????????????????????????????
?                    RESULT SCENE                                  ?
?  ??????????????????????????????????????????????????????????    ?
?  ?  Display Results                                        ?    ?
?  ?  ?? Final score                                         ?    ?
?  ?  ?? Victims saved                                       ?    ?
?  ?  ?? Save to Firebase                                    ?    ?
?  ??????????????????????????????????????????????????????????    ?
?                                                                   ?
?  Options:                                                        ?
?  ?? "Play Again" ? Return to LobbyMenu                          ?
?  ?? "Main Menu" ? Cleanup and return to MainMenu                ?
???????????????????????????????????????????????????????????????????
                            ?
                   User clicks "Main Menu"
                            ?
                            ?
                  ????????????????????
                  ? Cleanup Network  ?
                  ????????????????????
                  ? Stop Broadcasting?
                  ? Shutdown()       ?
                  ? Destroy NM       ?
                  ????????????????????
                           ?
                           ?
                  Back to MAIN MENU
                  (No network components again)
```

---

## ?? Key Points

### 1. MainMenu Scene
```
? NO NetworkManager
? NO NetworkManagerInitializer
? NO Network Components
? Just authentication and role storage
```

### 2. LobbyMenu Scene
```
? LobbyMenuManager spawns NetworkManager
? NetworkManager ? DontDestroyOnLoad
? Persists through all subsequent scenes
? UnityMainThreadDispatcher for thread safety
```

### 3. DontDestroyOnLoad Hierarchy
```
When game is running (after LobbyMenu loads):

DontDestroyOnLoad/
?? NetworkManager (Persistent)
?  ?? NetworkManager component
?  ?? UnityTransport component
?
?? UnityMainThreadDispatcher
   ?? Handles thread-safe callbacks
```

### 4. Scene-to-Scene Flow
```
MainMenu (No network)
    ?
LobbyMenu (Spawns NetworkManager)
    ?
LobbyRoom (Uses existing NetworkManager)
    ?
Game Scene (Uses existing NetworkManager)
    ?
Result (Uses existing NetworkManager)
    ?
MainMenu (Cleanup NetworkManager)
```

---

## ?? Visual Component Locations

```
PROJECT STRUCTURE:

Assets/
?? Prefabs/
?  ?? NetworkManager.prefab ? ?? ONLY HERE!
?
?? Scenes/
   ?
   ?? MainMenu.unity
   ?  ?? [NO NETWORK COMPONENTS]
   ?
   ?? LobbyMenu.unity
   ?  ?? LobbyMenuManager ? ?? Spawns NetworkManager
   ?  ?  ?? Network Manager Prefab: [Assign prefab here]
   ?  ?? UnityMainThreadDispatcher
   ?
   ?? LobbyRoom.unity
   ?  ?? LobbyRoomManager
   ?     ?? NetworkObject ? ?? Required!
   ?
   ?? [Game Scenes]
      ?? (NetworkManager already exists in DontDestroyOnLoad)
```

---

## ?? State Transitions

```
State 1: MAIN MENU
?? NetworkManager.Singleton: null
?? No network connections
?? Just UI and authentication

        ? User clicks "Play Game"

State 2: LOBBY MENU LOADS
?? LobbyMenuManager.Awake()
?? NetworkManager spawned
?? NetworkManager.Singleton: EXISTS ?
?? Ready to start host/client

        ? User creates/joins lobby

State 3: NETWORK ACTIVE
?? NetworkManager.Singleton: EXISTS ?
?? IsHost or IsClient: true
?? Broadcasting/Connected
?? Ready to load LobbyRoom

        ? Host loads LobbyRoom

State 4: IN LOBBY ROOM
?? NetworkManager.Singleton: EXISTS ?
?? Still connected
?? Settings syncing via NetworkVariables
?? Ready to start game

        ? Host starts game

State 5: IN GAME
?? NetworkManager.Singleton: EXISTS ?
?? Still connected
?? Game state syncing
?? Playing multiplayer

        ? Game ends

State 6: RESULTS
?? NetworkManager.Singleton: EXISTS ?
?? Displaying results
?? Ready to cleanup

        ? Return to main menu

State 7: CLEANUP
?? NetworkManager.Shutdown()
?? Destroy NetworkManager
?? Back to State 1
```

---

This diagram shows the **complete lifecycle** of NetworkManager in your lobby system!
